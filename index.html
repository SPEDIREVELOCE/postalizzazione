<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Gestione Raccomandate - Moduli PDF</title>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background:#f5f5f5; }
h1, h2 { color: #333; }
input { padding:5px; margin:3px; border-radius:4px; border:1px solid #ccc; }
button { padding:5px 10px; margin:3px; border:none; border-radius:4px; background:#4CAF50; color:white; cursor:pointer; }
button:hover { background:#45a049; }
.doc { border:1px solid #ccc; border-radius:6px; padding:10px; margin:10px 0; background:#fff; }
table { width:100%; border-collapse: collapse; margin-top: 10px; background:#fff; border-radius:6px; overflow:hidden; }
th, td { border:1px solid #ccc; padding:5px; text-align:left; }
th { background:#4CAF50; color:white; }
td button { background:#2196F3; margin:0 2px; }
td button:hover { background:#0b7dda; }
</style>
</head>
<body>

<h1>Gestione Raccomandate - Moduli PDF</h1>

<button id="startBatchBtn">Nuova Lavorazione</button>

<div id="mittenteSection" style="display:none;" class="doc">
    <h2>Mittente</h2>
    <input type="text" id="sender_name" placeholder="Nome" required>
    <input type="text" id="sender_surname" placeholder="Cognome" required><br>
    <input type="text" id="sender_street" placeholder="Via" required>
    <input type="text" id="sender_number" placeholder="Civico" required><br>
    <input type="text" id="sender_zip" placeholder="CAP" required>
    <input type="text" id="sender_city" placeholder="Città" required><br>
    <button id="saveMittenteBtn">Salva Mittente</button>
</div>

<div id="raccomandataSection" style="display:none;" class="doc">
    <h2>Nuova Raccomandata</h2>
    <input type="text" id="recipient_name" placeholder="Nome destinatario" required>
    <input type="text" id="recipient_surname" placeholder="Cognome destinatario" required><br>
    <input type="text" id="recipient_street" placeholder="Via destinatario" required>
    <input type="text" id="recipient_number" placeholder="Civico destinatario" required><br>
    <input type="text" id="recipient_zip" placeholder="CAP destinatario" required>
    <input type="text" id="recipient_city" placeholder="Città destinatario" required><br>
    <button id="addRaccomandataBtn">Aggiungi Raccomandata</button>
</div>

<h2>Lista Raccomandate in Lavorazione</h2>
<table id="batchTable">
<thead>
<tr>
    <th>Codice</th>
    <th>Destinatario</th>
    <th>Data</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button id="generateBatchPDFBtn" style="display:none;">Stampa/Scarica Tutto</button>

<h2>Storico Raccomandate</h2>
<table id="storicoTable">
<thead>
<tr>
    <th>Codice</th>
    <th>Mittente</th>
    <th>Destinatario</th>
    <th>Data</th>
    <th>Azioni</th>
</tr>
</thead>
<tbody></tbody>
</table>

<svg id="tempBarcode" style="display:none;"></svg>

<script>
let counter = parseInt(localStorage.getItem("counter")) || 1;
let storico = JSON.parse(localStorage.getItem("storico")) || [];
let batchList = [];
let mittente = {};

function generateCode() {
    let codeNumber = String(counter).padStart(12, '0');
    return '90018' + codeNumber;
}

function updateStoricoTable(){
    let tbody = document.querySelector("#storicoTable tbody");
    tbody.innerHTML="";
    storico.forEach((r,index)=>{
        let tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.code}</td>
                        <td>${r.mittente.name} ${r.mittente.surname}</td>
                        <td>${r.recipient.name} ${r.recipient.surname}</td>
                        <td>${r.date}</td>
                        <td>
                            <button onclick="downloadSinglePDF(${index},'etichetta')">Etichetta</button>
                            <button onclick="downloadSinglePDF(${index},'accettazione')">Accettazione</button>
                            <button onclick="downloadSinglePDF(${index},'ritorno')">Ritorno</button>
                        </td>`;
        tbody.appendChild(tr);
    });
}

// Eventi UI
document.getElementById("startBatchBtn").addEventListener("click", ()=>{
    document.getElementById("mittenteSection").style.display = "block";
});

document.getElementById("saveMittenteBtn").addEventListener("click", ()=>{
    mittente = {
        name: document.getElementById('sender_name').value,
        surname: document.getElementById('sender_surname').value,
        street: document.getElementById('sender_street').value,
        number: document.getElementById('sender_number').value,
        zip: document.getElementById('sender_zip').value,
        city: document.getElementById('sender_city').value
    };
    if(!mittente.name || !mittente.surname) { alert("Inserisci tutti i dati del mittente"); return; }
    document.getElementById("mittenteSection").style.display = "none";
    document.getElementById("raccomandataSection").style.display = "block";
    document.getElementById("generateBatchPDFBtn").style.display = "inline-block";
});

document.getElementById("addRaccomandataBtn").addEventListener("click", ()=>{
    let recipient = {
        name: document.getElementById('recipient_name').value,
        surname: document.getElementById('recipient_surname').value,
        street: document.getElementById('recipient_street').value,
        number: document.getElementById('recipient_number').value,
        zip: document.getElementById('recipient_zip').value,
        city: document.getElementById('recipient_city').value
    };
    if(!recipient.name || !recipient.surname) { alert("Inserisci tutti i dati del destinatario"); return; }
    
    let code = generateCode();
    counter++;
    localStorage.setItem("counter", counter);
    let date = new Date().toLocaleDateString();
    
    let raccomandata = { mittente, recipient, code, date };
    batchList.push(raccomandata);
    
    let tbody = document.querySelector("#batchTable tbody");
    let tr = document.createElement("tr");
    tr.innerHTML = `<td>${code}</td><td>${recipient.name} ${recipient.surname}</td><td>${date}</td>`;
    tbody.appendChild(tr);

    document.getElementById('recipient_name').value="";
    document.getElementById('recipient_surname').value="";
    document.getElementById('recipient_street').value="";
    document.getElementById('recipient_number').value="";
    document.getElementById('recipient_zip').value="";
    document.getElementById('recipient_city').value="";
});

// Funzione helper per PDF con layout simile al modulo
async function generateModulePDF(r, type, doc, yStart){
    const { jsPDF } = window.jspdf;
    let y = yStart;

    if(type=="etichetta"){
        JsBarcode("#tempBarcode", r.code, {format:"CODE128", width:2, height:40, displayValue:false});
        let svg = document.getElementById("tempBarcode");
        let svgData = new XMLSerializer().serializeToString(svg);
        let canvas = document.createElement("canvas");
        let ctx = canvas.getContext("2d");
        let DOMURL = window.URL || window.webkitURL || window;
        let img = new Image();
        let svgBlob = new Blob([svgData], {type:"image/svg+xml;charset=utf-8"});
        let url = DOMURL.createObjectURL(svgBlob);
        await new Promise(resolve=>{
            img.onload = ()=>{
                canvas.width = img.width; canvas.height = img.height;
                ctx.drawImage(img,0,0);
                let imgData = canvas.toDataURL("imagePNG");
                doc.addImage(imgData,'PNG',10,y,80,30);
                doc.setFontSize(12);
                doc.text(r.code, 10, y+35);
                doc.text("Data: "+r.date, 10, y+40);
                resolve();
                DOMURL.revokeObjectURL(url);
            };
            img.src=url;
        });
    } else {
        doc.setDrawColor(0);
        doc.rect(10,y,190,40); // rettangolo modulo
        doc.setFontSize(11);
        let title = type=="accettazione" ? "Ricevuta Accettazione" : "Ricevuta Ritorno";
        doc.text(title,12,y+5);
        doc.text(`Mittente: ${r.mittente.name} ${r.mittente.surname}`,12,y+12);
        doc.text(`Destinatario: ${r.recipient.name} ${r.recipient.surname}`,12,y+18);
        doc.text(`Codice: ${r.code}`,12,y+24);
        doc.text(`Data: ${r.date}`,12,y+30);
    }
    return y+50;
}

// Generazione batch PDF
document.getElementById("generateBatchPDFBtn").addEventListener("click", async ()=>{
    if(batchList.length===0){ alert("Nessuna raccomandata in lavorazione"); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:"mm",format:"a4"});
    let y=10;
    for(let r of batchList){
        y = await generateModulePDF(r,"etichetta",doc,y);
        y = await generateModulePDF(r,"accettazione",doc,y);
        y = await generateModulePDF(r,"ritorno",doc,y);
        if(y>250){ doc.addPage(); y=10; }
    }
    doc.save("Lavorazione_Raccomandate.pdf");
    // Salva nello storico
    storico.push(...batchList);
    localStorage.setItem("storico", JSON.stringify(storico));
    batchList=[];
    document.querySelector("#batchTable tbody").innerHTML="";
    updateStoricoTable();
});

// PDF singoli dallo storico
async function downloadSinglePDF(index,type){
    let r = storico[index];
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:"mm", format:"a4"});
    await generateModulePDF(r,type,doc,10);
    doc.save(`${type}_${r.code}.pdf`);
}

// Aggiorna storico al caricamento
updateStoricoTable();
</script>

</body>
</html>
